{"ast":null,"code":"import { Tree, utils } from 'phylocanvas';\nconst {\n  getPixelRatio\n} = utils.canvas;\nconst DEFAULTS = {\n  active: true\n};\n\nfunction drawBranchLength() {\n  const {\n    branchLength\n  } = this;\n  const ctx = this.canvas;\n  const canvas = ctx.canvas;\n  const pixelRatio = getPixelRatio(ctx);\n  const pi = 3.141592653589793;\n  const textSize = this.textSize * this.zoom;\n  ctx.save();\n  ctx.font = `${textSize}px ${this.font}`;\n  ctx.fillStyle = this.branchColour;\n  ctx.textBaseline = \"bottom\";\n  ctx.textAlign = \"left\";\n  console.log(this.zoom, pixelRatio);\n\n  for (let branch in this.branches) {\n    if (this.branches[branch].branchLength == 0) {\n      continue;\n    }\n\n    branch = this.branches[branch];\n    let centerX = (this.offsetx + (branch.startx + branch.centerx) / 2 * this.zoom / pixelRatio) * pixelRatio;\n    let centerY = (this.offsety + (branch.starty + branch.centery) / 2 * this.zoom / pixelRatio) * pixelRatio;\n    let x = (this.offsetx + branch.centerx * this.zoom / pixelRatio) * pixelRatio;\n    let y = (this.offsety + branch.centery * this.zoom / pixelRatio) * pixelRatio;\n\n    if (this.treeType == \"rectangular\") {\n      ctx.textAlign = \"center\";\n      ctx.fillText(branch.branchLength, centerX, y);\n    } else if (this.treeType == \"hierarchical\") {\n      ctx.textBaseline = \"middle\";\n      ctx.fillText(branch.branchLength, x, centerY);\n    } else {\n      // TODO: Fix floating position of branch lengths on line\n      if (centerY > y) {\n        ctx.textAlign = \"right\";\n        centerX = centerX - 5 * this.zoom;\n      } else {\n        ctx.textAlign = \"left\";\n        centerX = centerX + 5 * this.zoom;\n      }\n\n      if (centerX > x) {\n        ctx.textBaseline = \"top\";\n        centerY = centerY + 5 * this.zoom;\n      } else {\n        ctx.textBaseline = \"bottom\";\n        centerY = centerY - 5 * this.zoom;\n      }\n\n      ctx.fillText(branch.branchLength, centerX, centerY);\n    } //  y = (this.offsety + branch.centery * this.zoom / 2) * pixelRatio\n    //} else if (pi * 1 / 4 < branch.angle && branch.angle < pi * 3 / 4 || pi + pi * 1 / 4 < branch.angle && branch.angle < pi + pi * 3 / 4) {\n    //  x = (this.offsetx + textSize + branch.centerx * this.zoom / 2) * pixelRatio\n    //  y += textSize * pixelRatio\n    //}\n\n  }\n\n  ctx.restore();\n}\n\nexport default function plugin(decorate) {\n  decorate(this, 'createTree', (delegate, args) => {\n    const tree = delegate(...args);\n    const [, config = {}] = args;\n    tree.branchLength = Object.assign({}, DEFAULTS, config.branchLength || {});\n    return tree;\n  });\n  decorate(Tree, 'draw', function (delegate, args) {\n    delegate.apply(this, args);\n\n    if (this.branchLength.active) {\n      drawBranchLength.apply(this);\n    }\n  });\n}","map":{"version":3,"sources":["/var/www/pathogen-intelligence.tgen.org/epitools/my_modules/phylocanvas-plugin-branch-length/index.js"],"names":["Tree","utils","getPixelRatio","canvas","DEFAULTS","active","drawBranchLength","branchLength","ctx","pixelRatio","pi","textSize","zoom","save","font","fillStyle","branchColour","textBaseline","textAlign","console","log","branch","branches","centerX","offsetx","startx","centerx","centerY","offsety","starty","centery","x","y","treeType","fillText","restore","plugin","decorate","delegate","args","tree","config","Object","assign","apply"],"mappings":"AAAA,SAASA,IAAT,EAAeC,KAAf,QAA4B,aAA5B;AAEA,MAAM;AAAEC,EAAAA;AAAF,IAAoBD,KAAK,CAACE,MAAhC;AAEA,MAAMC,QAAQ,GAAG;AACfC,EAAAA,MAAM,EAAE;AADO,CAAjB;;AAIA,SAASC,gBAAT,GAA4B;AAE1B,QAAM;AAAEC,IAAAA;AAAF,MAAmB,IAAzB;AACA,QAAMC,GAAG,GAAG,KAAKL,MAAjB;AACA,QAAMA,MAAM,GAAGK,GAAG,CAACL,MAAnB;AACA,QAAMM,UAAU,GAAGP,aAAa,CAACM,GAAD,CAAhC;AACA,QAAME,EAAE,GAAG,iBAAX;AACA,QAAMC,QAAQ,GAAG,KAAKA,QAAL,GAAgB,KAAKC,IAAtC;AAEAJ,EAAAA,GAAG,CAACK,IAAJ;AAEAL,EAAAA,GAAG,CAACM,IAAJ,GAAY,GAAEH,QAAS,MAAK,KAAKG,IAAK,EAAtC;AACAN,EAAAA,GAAG,CAACO,SAAJ,GAAgB,KAAKC,YAArB;AACAR,EAAAA,GAAG,CAACS,YAAJ,GAAmB,QAAnB;AACAT,EAAAA,GAAG,CAACU,SAAJ,GAAgB,MAAhB;AACAC,EAAAA,OAAO,CAACC,GAAR,CAAY,KAAKR,IAAjB,EAAuBH,UAAvB;;AAEA,OAAK,IAAIY,MAAT,IAAmB,KAAKC,QAAxB,EAAkC;AAChC,QAAI,KAAKA,QAAL,CAAcD,MAAd,EAAsBd,YAAtB,IAAsC,CAA1C,EAA6C;AAC3C;AACD;;AACDc,IAAAA,MAAM,GAAG,KAAKC,QAAL,CAAcD,MAAd,CAAT;AACA,QAAIE,OAAO,GAAG,CAAC,KAAKC,OAAL,GAAe,CAACH,MAAM,CAACI,MAAP,GAAgBJ,MAAM,CAACK,OAAxB,IAAmC,CAAnC,GAAuC,KAAKd,IAA5C,GAAmDH,UAAnE,IAAiFA,UAA/F;AACA,QAAIkB,OAAO,GAAG,CAAC,KAAKC,OAAL,GAAe,CAACP,MAAM,CAACQ,MAAP,GAAgBR,MAAM,CAACS,OAAxB,IAAmC,CAAnC,GAAuC,KAAKlB,IAA5C,GAAmDH,UAAnE,IAAiFA,UAA/F;AACA,QAAIsB,CAAC,GAAG,CAAC,KAAKP,OAAL,GAAeH,MAAM,CAACK,OAAP,GAAiB,KAAKd,IAAtB,GAA6BH,UAA7C,IAA2DA,UAAnE;AACA,QAAIuB,CAAC,GAAG,CAAC,KAAKJ,OAAL,GAAeP,MAAM,CAACS,OAAP,GAAiB,KAAKlB,IAAtB,GAA6BH,UAA7C,IAA2DA,UAAnE;;AACA,QAAI,KAAKwB,QAAL,IAAiB,aAArB,EAAoC;AAClCzB,MAAAA,GAAG,CAACU,SAAJ,GAAgB,QAAhB;AACAV,MAAAA,GAAG,CAAC0B,QAAJ,CAAab,MAAM,CAACd,YAApB,EAAkCgB,OAAlC,EAA2CS,CAA3C;AACD,KAHD,MAGO,IAAI,KAAKC,QAAL,IAAiB,cAArB,EAAqC;AAC1CzB,MAAAA,GAAG,CAACS,YAAJ,GAAmB,QAAnB;AACAT,MAAAA,GAAG,CAAC0B,QAAJ,CAAab,MAAM,CAACd,YAApB,EAAkCwB,CAAlC,EAAqCJ,OAArC;AACD,KAHM,MAGA;AACL;AACA,UAAIA,OAAO,GAAGK,CAAd,EAAiB;AACfxB,QAAAA,GAAG,CAACU,SAAJ,GAAgB,OAAhB;AACAK,QAAAA,OAAO,GAAGA,OAAO,GAAG,IAAI,KAAKX,IAA7B;AACD,OAHD,MAGO;AACLJ,QAAAA,GAAG,CAACU,SAAJ,GAAgB,MAAhB;AACAK,QAAAA,OAAO,GAAGA,OAAO,GAAG,IAAI,KAAKX,IAA7B;AACD;;AACD,UAAIW,OAAO,GAAGQ,CAAd,EAAiB;AACfvB,QAAAA,GAAG,CAACS,YAAJ,GAAmB,KAAnB;AACAU,QAAAA,OAAO,GAAGA,OAAO,GAAG,IAAI,KAAKf,IAA7B;AACD,OAHD,MAGO;AACLJ,QAAAA,GAAG,CAACS,YAAJ,GAAmB,QAAnB;AACAU,QAAAA,OAAO,GAAGA,OAAO,GAAG,IAAI,KAAKf,IAA7B;AACD;;AACDJ,MAAAA,GAAG,CAAC0B,QAAJ,CAAab,MAAM,CAACd,YAApB,EAAkCgB,OAAlC,EAA2CI,OAA3C;AACD,KAhC+B,CAiChC;AACA;AACA;AACA;AACA;;AACD;;AAEDnB,EAAAA,GAAG,CAAC2B,OAAJ;AACD;;AAED,eAAe,SAASC,MAAT,CAAgBC,QAAhB,EAA0B;AACvCA,EAAAA,QAAQ,CAAC,IAAD,EAAO,YAAP,EAAqB,CAACC,QAAD,EAAWC,IAAX,KAAoB;AAC/C,UAAMC,IAAI,GAAGF,QAAQ,CAAC,GAAGC,IAAJ,CAArB;AACA,UAAM,GAAIE,MAAM,GAAG,EAAb,IAAoBF,IAA1B;AACAC,IAAAA,IAAI,CAACjC,YAAL,GAAoBmC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBvC,QAAlB,EAA4BqC,MAAM,CAAClC,YAAP,IAAuB,EAAnD,CAApB;AACA,WAAOiC,IAAP;AACD,GALO,CAAR;AAMAH,EAAAA,QAAQ,CAACrC,IAAD,EAAO,MAAP,EAAe,UAAUsC,QAAV,EAAoBC,IAApB,EAA0B;AAC/CD,IAAAA,QAAQ,CAACM,KAAT,CAAe,IAAf,EAAqBL,IAArB;;AACA,QAAI,KAAKhC,YAAL,CAAkBF,MAAtB,EAA8B;AAC5BC,MAAAA,gBAAgB,CAACsC,KAAjB,CAAuB,IAAvB;AACD;AACF,GALO,CAAR;AAMD","sourcesContent":["import { Tree, utils } from 'phylocanvas';\n\nconst { getPixelRatio } = utils.canvas;\n\nconst DEFAULTS = {\n  active: true,\n};\n\nfunction drawBranchLength() {\n\n  const { branchLength } = this;\n  const ctx = this.canvas;\n  const canvas = ctx.canvas;\n  const pixelRatio = getPixelRatio(ctx);\n  const pi = 3.141592653589793\n  const textSize = this.textSize * this.zoom\n\n  ctx.save();\n\n  ctx.font = `${textSize}px ${this.font}`;\n  ctx.fillStyle = this.branchColour;\n  ctx.textBaseline = \"bottom\";\n  ctx.textAlign = \"left\";\n  console.log(this.zoom, pixelRatio)\n\n  for (let branch in this.branches) {\n    if (this.branches[branch].branchLength == 0) {\n      continue\n    }\n    branch = this.branches[branch]\n    let centerX = (this.offsetx + (branch.startx + branch.centerx) / 2 * this.zoom / pixelRatio) * pixelRatio\n    let centerY = (this.offsety + (branch.starty + branch.centery) / 2 * this.zoom / pixelRatio) * pixelRatio\n    let x = (this.offsetx + branch.centerx * this.zoom / pixelRatio) * pixelRatio\n    let y = (this.offsety + branch.centery * this.zoom / pixelRatio) * pixelRatio\n    if (this.treeType == \"rectangular\") {\n      ctx.textAlign = \"center\"\n      ctx.fillText(branch.branchLength, centerX, y)\n    } else if (this.treeType == \"hierarchical\") {\n      ctx.textBaseline = \"middle\"\n      ctx.fillText(branch.branchLength, x, centerY)\n    } else {\n      // TODO: Fix floating position of branch lengths on line\n      if (centerY > y) {\n        ctx.textAlign = \"right\"\n        centerX = centerX - 5 * this.zoom\n      } else {\n        ctx.textAlign = \"left\"\n        centerX = centerX + 5 * this.zoom\n      }\n      if (centerX > x) {\n        ctx.textBaseline = \"top\"\n        centerY = centerY + 5 * this.zoom\n      } else {\n        ctx.textBaseline = \"bottom\"\n        centerY = centerY - 5 * this.zoom\n      }\n      ctx.fillText(branch.branchLength, centerX, centerY)\n    }\n    //  y = (this.offsety + branch.centery * this.zoom / 2) * pixelRatio\n    //} else if (pi * 1 / 4 < branch.angle && branch.angle < pi * 3 / 4 || pi + pi * 1 / 4 < branch.angle && branch.angle < pi + pi * 3 / 4) {\n    //  x = (this.offsetx + textSize + branch.centerx * this.zoom / 2) * pixelRatio\n    //  y += textSize * pixelRatio\n    //}\n  }\n\n  ctx.restore();\n}\n\nexport default function plugin(decorate) {\n  decorate(this, 'createTree', (delegate, args) => {\n    const tree = delegate(...args);\n    const [ , config = {} ] = args;\n    tree.branchLength = Object.assign({}, DEFAULTS, config.branchLength || {});\n    return tree;\n  });\n  decorate(Tree, 'draw', function (delegate, args) {\n    delegate.apply(this, args);\n    if (this.branchLength.active) {\n      drawBranchLength.apply(this);\n    }\n  });\n}\n"]},"metadata":{},"sourceType":"module"}