{"ast":null,"code":"import { Tree, utils } from 'phylocanvas';\nconst {\n  getPixelRatio\n} = utils.canvas;\nconst DEFAULTS = {\n  active: true\n};\n\nfunction addListeners() {\n  const tree = this;\n  const ctx = this.canvas;\n  const canvas = ctx.canvas;\n  const pixelRatio = getPixelRatio(ctx);\n  const textSize = this.textSize;\n\n  if (this.treeStats.active) {\n    //cleanup old event listeners\n    for (let eventListener of this.eventListeners.mousemove.filter(eventListener => eventListener.listener.name == \"treeStats\")) {\n      this.removeListener('mousemove', eventListener.listener, canvas);\n    }\n\n    console.log(this);\n\n    for (let leaf of this.leaves) {\n      this.addListener('mousemove', treeStats, canvas);\n\n      function treeStats(e) {\n        let path = new Path2D();\n        let centerX = (tree.offsetx + (leaf.minx + leaf.maxx) * tree.zoom / pixelRatio / 2) * pixelRatio;\n        let centerY = (tree.offsety + (leaf.miny + leaf.maxy) * tree.zoom / pixelRatio / 2) * pixelRatio;\n        let startX = centerX + -20 * Math.cos(leaf.angle);\n        let startY = centerY + -20 * Math.sin(leaf.angle);\n        let endX = centerX + 70 * Math.cos(leaf.angle);\n        let endY = centerY + 70 * Math.sin(leaf.angle);\n        ctx.save();\n        ctx.fillStyle = \"rgb(0, 0, 255)\";\n        ctx.strokeStyle = \"rgb(0, 0, 255)\";\n        ctx.beginPath();\n        ctx.arc(centerX, centerY, 10, 0, 2 * Math.PI);\n        ctx.closePath();\n        ctx.fill();\n        ctx.beginPath();\n        ctx.moveTo(startX, startY);\n        ctx.lineTo(endX, endY);\n        ctx.stroke();\n        ctx.restore();\n        let x = (tree.offsetx - tree.baseNodeSize * tree.zoom + leaf.getLabelStartX() * tree.zoom / pixelRatio + leaf.maxx * tree.zoom / pixelRatio) * pixelRatio;\n        let y = (tree.offsety + (leaf.maxy + leaf.miny) / 2 * tree.zoom / pixelRatio) * pixelRatio;\n        ctx.save();\n        ctx.font = `${tree.textSize * pixelRatio}px ${tree.font}`;\n        let width = ctx.measureText(leaf.label).width * pixelRatio * tree.zoom / tree.zoomFactor;\n        let height = ctx.measureText(\"M\").width * pixelRatio * tree.zoom / tree.zoomFactor / 2;\n        ctx.restore();\n        path.moveTo(x, y + height);\n        path.lineTo(x + width, y + height);\n        path.lineTo(x + width, y - height);\n        path.lineTo(x, y - height);\n        path.lineTo(x, y + height);\n        path.closePath();\n        ctx.stroke(path);\n\n        if (ctx.isPointInPath(path, e.offsetX * pixelRatio, e.offsetY * pixelRatio)) {\n          leaf.highlighted = true;\n          ctx.save();\n          ctx.fillStyle = \"rgb(255, 255, 255)\";\n          x = e.offsetX * pixelRatio;\n          y = e.offsetY * pixelRatio;\n          ctx.clearRect(x + 20, y + 10, 200, 100);\n          ctx.fillRect(x + 20, y + 10, 200, 100);\n          ctx.restore();\n          console.log(leaf);\n        } else {\n          leaf.highlighted = false;\n        }\n      }\n    }\n  }\n}\n\nexport default function plugin(decorate) {\n  decorate(this, 'createTree', (delegate, args) => {\n    const tree = delegate(...args);\n    const [, config = {}] = args;\n    tree.treeStats = Object.assign({}, DEFAULTS, config.treeStats || {});\n    return tree;\n  });\n  decorate(Tree, 'load', function (delegate, args) {\n    delegate.apply(this, args);\n    addListeners.apply(this);\n    let ctx = this.canvas;\n    this.addListener('mousemove', e => {\n      let path = new Path2D();\n      path.moveTo(0, 0);\n      path.lineTo(e.offsetX * getPixelRatio(ctx), e.offsetY * getPixelRatio(ctx));\n      path.closePath();\n      ctx.stroke(path);\n    });\n  });\n}","map":{"version":3,"sources":["/var/www/pathogen-intelligence.tgen.org/epitools/my_modules/phylocanvas-plugin-tree-stats/index.js"],"names":["Tree","utils","getPixelRatio","canvas","DEFAULTS","active","addListeners","tree","ctx","pixelRatio","textSize","treeStats","eventListener","eventListeners","mousemove","filter","listener","name","removeListener","console","log","leaf","leaves","addListener","e","path","Path2D","centerX","offsetx","minx","maxx","zoom","centerY","offsety","miny","maxy","startX","Math","cos","angle","startY","sin","endX","endY","save","fillStyle","strokeStyle","beginPath","arc","PI","closePath","fill","moveTo","lineTo","stroke","restore","x","baseNodeSize","getLabelStartX","y","font","width","measureText","label","zoomFactor","height","isPointInPath","offsetX","offsetY","highlighted","clearRect","fillRect","plugin","decorate","delegate","args","config","Object","assign","apply"],"mappings":"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","sourcesContent":["import { Tree, utils } from 'phylocanvas';\n\nconst { getPixelRatio } = utils.canvas;\n\nconst DEFAULTS = {\n  active: true,\n};\n\nfunction addListeners() {\n  const tree = this\n  const ctx = this.canvas;\n  const canvas = ctx.canvas;\n  const pixelRatio = getPixelRatio(ctx);\n  const textSize = this.textSize\n  if (this.treeStats.active) {\n      //cleanup old event listeners\n      for (let eventListener of this.eventListeners.mousemove.filter(eventListener => eventListener.listener.name == \"treeStats\")) {\n        this.removeListener('mousemove', eventListener.listener, canvas)\n      }\n      console.log(this)\n      for (let leaf of this.leaves) {\n        this.addListener('mousemove', treeStats, canvas)\n        function treeStats(e) {\n          let path = new Path2D()\n\n          let centerX = (tree.offsetx + (leaf.minx + leaf.maxx) * tree.zoom / pixelRatio / 2) * pixelRatio\n          let centerY = (tree.offsety + (leaf.miny + leaf.maxy) * tree.zoom / pixelRatio / 2) * pixelRatio\n          let startX = centerX + (-20 * Math.cos(leaf.angle))\n          let startY = centerY + (-20 * Math.sin(leaf.angle))\n          let endX = centerX + (70 * Math.cos(leaf.angle))\n          let endY = centerY + (70 * Math.sin(leaf.angle))\n\n\n          ctx.save()\n          ctx.fillStyle = \"rgb(0, 0, 255)\"\n          ctx.strokeStyle = \"rgb(0, 0, 255)\"\n          ctx.beginPath()\n          ctx.arc(centerX, centerY, 10, 0, 2 * Math.PI)\n          ctx.closePath()\n          ctx.fill()\n          ctx.beginPath()\n          ctx.moveTo(startX, startY)\n          ctx.lineTo(endX, endY)\n          ctx.stroke()\n          ctx.restore()\n\n          let x = (tree.offsetx - tree.baseNodeSize * tree.zoom + leaf.getLabelStartX() * tree.zoom / pixelRatio + leaf.maxx * tree.zoom / pixelRatio) * pixelRatio\n          let y = (tree.offsety + (leaf.maxy + leaf.miny) / 2 * tree.zoom / pixelRatio) * pixelRatio\n          ctx.save()\n          ctx.font = `${tree.textSize * pixelRatio}px ${tree.font}`;\n          let width = ctx.measureText(leaf.label).width * pixelRatio * tree.zoom / tree.zoomFactor\n          let height = ctx.measureText(\"M\").width * pixelRatio * tree.zoom / tree.zoomFactor / 2\n          ctx.restore()\n          path.moveTo(x, y + height)\n          path.lineTo(x + width, y + height)\n          path.lineTo(x + width, y - height)\n          path.lineTo(x, y - height)\n          path.lineTo(x, y + height)\n          path.closePath()\n          ctx.stroke(path)\n          if (ctx.isPointInPath(path, e.offsetX * pixelRatio, e.offsetY * pixelRatio)) {\n            leaf.highlighted = true\n            ctx.save()\n            ctx.fillStyle = \"rgb(255, 255, 255)\"\n            x = e.offsetX * pixelRatio\n            y = e.offsetY * pixelRatio\n            ctx.clearRect(x + 20, y + 10, 200, 100)\n            ctx.fillRect(x + 20, y + 10, 200, 100)\n            ctx.restore()\n            console.log(leaf)\n          } else {\n            leaf.highlighted = false\n          }\n        }\n      }\n  }\n}\n\nexport default function plugin(decorate) {\n  decorate(this, 'createTree', (delegate, args) => {\n    const tree = delegate(...args);\n    const [ , config = {} ] = args;\n    tree.treeStats = Object.assign({}, DEFAULTS, config.treeStats || {});\n    return tree;\n  });\n  decorate(Tree, 'load', function (delegate, args) {\n    delegate.apply(this, args);\n    addListeners.apply(this)\n    let ctx = this.canvas\n    this.addListener('mousemove', (e) => {\n      let path = new Path2D()\n      path.moveTo(0, 0)\n      path.lineTo(e.offsetX * getPixelRatio(ctx), e.offsetY * getPixelRatio(ctx))\n      path.closePath()\n      ctx.stroke(path)\n    })\n\n  });\n}\n"]},"metadata":{},"sourceType":"module"}