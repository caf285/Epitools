{"ast":null,"code":"import { Tree, utils } from 'phylocanvas';\nconst {\n  getPixelRatio\n} = utils.canvas;\nconst DEFAULTS = {\n  active: true,\n  pairwiseMatrix: {},\n  clusterActive: true,\n  clusterDraw: true,\n  clusterMatrix: new Set(),\n  clusterMaxDistance: 20,\n  clusterDistance: 3,\n  clusterSamples: 3\n};\n\nfunction walkMatrix(tree, start, node, walked, distance, max) {\n  walked.push(node);\n\n  if (distance >= max) {\n    return;\n  }\n\n  if (node !== start && node.leaf === true) {\n    tree.pairwiseOps.pairwiseMatrix[start.id].push([node.id, distance]);\n  }\n\n  for (let child of node.children) {\n    if (!walked.includes(child)) {\n      let newDistance = distance + child.branchLength;\n      newDistance = parseFloat(newDistance.toFixed(10));\n      walkMatrix(tree, start, child, walked, newDistance, max);\n    }\n  }\n\n  if (node.parent && !walked.includes(node.parent)) {\n    let newDistance = distance + node.branchLength;\n    newDistance = parseFloat(newDistance.toFixed(10));\n    walkMatrix(tree, start, node.parent, walked, newDistance, max);\n  }\n}\n\nfunction buildPairwiseMatrix() {\n  for (let leaf of this.leaves) {\n    this.pairwiseOps.pairwiseMatrix[leaf.id] = [];\n    walkMatrix(this, leaf, leaf, [], 0, this.pairwiseOps.clusterMaxDistance);\n  }\n}\n\nfunction buildClusterMatrix() {\n  console.log(this.pairwiseOps.pairwiseMatrix);\n  this.pairwiseOps.clusterMatrix.clear();\n\n  for (let leaf in this.pairwiseOps.pairwiseMatrix) {\n    let cluster = new Set([leaf]);\n\n    for (let node of this.pairwiseOps.pairwiseMatrix[leaf]) {\n      if (node[1] <= this.pairwiseOps.clusterDistance) {\n        cluster.add(node[0]);\n      }\n    }\n\n    if (cluster.length >= this.pairwiseOps.clusterSamples && !this.pairwiseOps.clusterMatrix.has(cluster)) {\n      this.pairwiseOps.clusterMatrix.add(cluster);\n    }\n\n    console.log(this.pairwiseOps.clusterMatrix);\n  }\n}\n\nfunction colorNode() {\n  for (let leaf of this.leaves) {\n    leaf.setDisplay({\n      colour: this.branchColour\n    });\n    leaf.label = leaf.id;\n  }\n\n  for (let cluster of this.pairwiseOps.clusterMatrix) {\n    for (let id of cluster) {\n      for (let leaf of this.findLeaves(id)) {\n        leaf.label += \"+\";\n        leaf.setDisplay({\n          colour: 'red'\n        });\n      }\n    }\n  }\n\n  this.draw();\n}\n\nexport default function plugin(decorate) {\n  decorate(this, 'createTree', (delegate, args) => {\n    const tree = delegate(...args);\n    const [, config = {}] = args;\n    tree.pairwiseOps = Object.assign({}, DEFAULTS, config.pairwiseOps || {});\n    return tree;\n  });\n  decorate(Tree, 'load', function (delegate, args) {\n    delegate.apply(this, args);\n\n    if (this.pairwiseOps.active) {\n      buildPairwiseMatrix.apply(this);\n\n      if (this.pairwiseOps.clusterActive) {\n        this.pairwiseOps.clusterDraw = true;\n      }\n    }\n  });\n  decorate(Tree, 'draw', function (delegate, args) {\n    delegate.apply(this, args);\n\n    if (this.pairwiseOps.clusterActive) {\n      if (this.pairwiseOps.clusterDraw) {\n        this.pairwiseOps.clusterDraw = false;\n        buildClusterMatrix.apply(this);\n        colorNode.apply(this);\n      }\n    }\n  });\n}","map":{"version":3,"sources":["/var/www/pathogen-intelligence.tgen.org/epitools/my_modules/phylocanvas-plugin-pairwise-ops/index.js"],"names":["Tree","utils","getPixelRatio","canvas","DEFAULTS","active","pairwiseMatrix","clusterActive","clusterDraw","clusterMatrix","Set","clusterMaxDistance","clusterDistance","clusterSamples","walkMatrix","tree","start","node","walked","distance","max","push","leaf","pairwiseOps","id","child","children","includes","newDistance","branchLength","parseFloat","toFixed","parent","buildPairwiseMatrix","leaves","buildClusterMatrix","console","log","clear","cluster","add","length","has","colorNode","setDisplay","colour","branchColour","label","findLeaves","draw","plugin","decorate","delegate","args","config","Object","assign","apply"],"mappings":"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","sourcesContent":["import { Tree, utils } from 'phylocanvas';\n\nconst { getPixelRatio } = utils.canvas;\n\nconst DEFAULTS = {\n  active: true,\n  pairwiseMatrix: {},\n  clusterActive: true,\n  clusterDraw: true,\n  clusterMatrix: new Set(),\n  clusterMaxDistance: 20,\n  clusterDistance: 3,\n  clusterSamples: 3,\n};\n\nfunction walkMatrix(tree, start, node, walked, distance, max) {\n  walked.push(node)\n\n  if (distance >= max) {\n    return\n  }\n  if (node !== start && node.leaf === true) {\n    tree.pairwiseOps.pairwiseMatrix[start.id].push([node.id, distance])\n  }\n  for (let child of node.children) {\n    if (! walked.includes(child)) {\n      let newDistance = distance + child.branchLength\n      newDistance = parseFloat(newDistance.toFixed(10))\n      walkMatrix(tree, start, child, walked, newDistance, max)\n    }\n  }\n  if (node.parent && ! walked.includes(node.parent)) {\n    let newDistance = distance + node.branchLength\n    newDistance = parseFloat(newDistance.toFixed(10))\n    walkMatrix(tree, start, node.parent, walked, newDistance, max)\n  }\n}\n\nfunction buildPairwiseMatrix() {\n  for (let leaf of this.leaves) {\n    this.pairwiseOps.pairwiseMatrix[leaf.id] = []\n    walkMatrix(this, leaf, leaf, [], 0, this.pairwiseOps.clusterMaxDistance)\n  }\n}\n\nfunction buildClusterMatrix() {\n  console.log(this.pairwiseOps.pairwiseMatrix)\n  this.pairwiseOps.clusterMatrix.clear()\n  for (let leaf in this.pairwiseOps.pairwiseMatrix) {\n    let cluster = new Set([leaf])\n    for (let node of this.pairwiseOps.pairwiseMatrix[leaf]) {\n      if (node[1] <= this.pairwiseOps.clusterDistance) {\n        cluster.add(node[0])\n      }\n    }\n    if (cluster.length >= this.pairwiseOps.clusterSamples && ! this.pairwiseOps.clusterMatrix.has(cluster)) {\n      this.pairwiseOps.clusterMatrix.add(cluster)\n    }\n    console.log(this.pairwiseOps.clusterMatrix)\n  }\n}\n\nfunction colorNode() {\n  for (let leaf of this.leaves) {\n    leaf.setDisplay({\n      colour: this.branchColour,\n    })\n    leaf.label = leaf.id\n  }\n  for (let cluster of this.pairwiseOps.clusterMatrix) {\n    for (let id of cluster) {\n      for (let leaf of this.findLeaves(id)) {\n        leaf.label += \"+\"\n        leaf.setDisplay({\n          colour: 'red',\n        })\n      }\n    }\n  }\n  this.draw()\n}\n\nexport default function plugin(decorate) {\n  decorate(this, 'createTree', (delegate, args) => {\n    const tree = delegate(...args);\n    const [ , config = {} ] = args;\n    tree.pairwiseOps = Object.assign({}, DEFAULTS, config.pairwiseOps || {});\n    return tree;\n  });\n  decorate(Tree, 'load', function (delegate, args) {\n    delegate.apply(this, args);\n    if (this.pairwiseOps.active) {\n      buildPairwiseMatrix.apply(this);\n      if (this.pairwiseOps.clusterActive) {\n        this.pairwiseOps.clusterDraw = true;\n      }\n    }   \n  });\n  decorate(Tree, 'draw', function (delegate, args) {\n    delegate.apply(this, args);\n    if (this.pairwiseOps.clusterActive) {\n      if (this.pairwiseOps.clusterDraw) {\n        this.pairwiseOps.clusterDraw = false;\n        buildClusterMatrix.apply(this);\n        colorNode.apply(this)\n      }\n    }\n  });\n}\n"]},"metadata":{},"sourceType":"module"}