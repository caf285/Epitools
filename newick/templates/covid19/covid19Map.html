{% extends "newick/samples.html" %}

{% block static %}
  {{ block.super }}
  {% load leaflet_tags %}
  {% leaflet_css %}
  {% leaflet_js %}
  {% load static %}

  <script src="{% static '/newick/js/azCov.js'%}"></script>
  <style>
    .leaflet-container {  /* all maps */
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    .mapIcon {
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      color: #000;
    }
    .legend {
      line-height: 18px;
      background-color: white;
      padding: 15px;
      border-radius: 5px;
      color: #555;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
  </style>


  <!--====================================================================================================( SCRIPTS )-->
  <script>
    //=========================( Initialize and Update Map )
    window.addEventListener("map:init", function (e) {
      function getColor(d) {
        return d > 200 ? '#008026' :
               d > 100 ? '#00BD26' :
               d > 50  ? '#1AE31C' :
               d > 20  ? '#4EFC2A' :
               d > 10  ? '#8DFD3C' :
               d > 5   ? '#B2FE4C' :
               d > 1   ? '#D9FE76' :
                         '#EDFFA0';
      }
      detail = e.detail;
      //----- add grey and dark heat layers to map
      var baseLayers = {
        "Grey": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {'attribution': 'Esri &mdash; Esri, DeLorme, NAVTEQ', 'maxZoom': 16}),
        "Dark Grey": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}', {'attribution': 'Esri &mdash; Esri, DeLorme, NAVTEQ', 'maxZoom': 16}),
      };
      L.control.layers(baseLayers, null).addTo(detail.map);
      detail.map.addLayer(baseLayers["Grey"])


      //----- add all polygon and icon map data
      var covLayers = new Object();
      for (let hash in azCov) {
        covLayers[hash] = new Object();
        for (let district in azCov[hash]) {
          // get positive/tested
          let tested = 0
          let positive = 0
          for (let test in azCov[hash][district]["tested"]) {
            tested += 1
            if (azCov[hash][district]["tested"][test][3] == "+") {
              positive += 1
            }    
          }
          // add polygon to map
          covLayers[hash][district] = new Object();
          covLayers[hash][district]["polygon"] = L.polygon(azCov[hash][district]["polygon"], {
            title: district,
            clickable: false,
            opacity: 0.75,
            color: "#555",
            weight: 1,
            fillColor: getColor(positive),
            fillOpacity: 1
          })
          // mouseover fill display
          covLayers[hash][district]["polygon"].addEventListener("click", function () {
            let stats = ["Name: " + district, "Population: " + azCov[hash][district]["population"]]
            for (let zip5 in azCov[hash][district]["zip5"]) {
              let zipPositive = 0;
              let zipTested = 0;
              for (let test in azCov[hash][district]["zip5"][zip5]["tested"]) {
                zipTested += 1
                if (azCov[hash][district]["zip5"][zip5]["tested"][test][3] == "+") {
                  zipPositive += 1;
                }
              }
              if (positive > 0) {
                stats.push(zip5 + ": " + String(zipPositive) + "/" + String(zipTested))
              }
            }
            document.getElementById("covStats").innerHTML = stats.join("</br>")
          });
          
          // add icon to map
          let icon = L.divIcon({
            className: "mapIcon",
            iconSize: [75, 75],
            html: district + "</br>" + azCov[hash][district]["population"] + "</br>" + String(positive) + "/" + String(tested)
          });
          covLayers[hash][district]["icon"] = L.marker(azCov[hash][district]["average"], {
            icon: icon,
            interactive: false
          });
        }
      }

      //----- add markers to map on click
      for (let drop of document.getElementById("mapDropdown").getElementsByClassName("dropdown-item")) {
        drop.addEventListener("click", function (e) {
          document.getElementById("covStats").innerHTML = ""
          detail.map.eachLayer(function (layer) {
            for (let hash in covLayers){
              for (let district in covLayers[hash]) {
                detail.map.removeLayer(covLayers[hash][district]["polygon"])
                detail.map.removeLayer(covLayers[hash][district]["icon"])
              }
            }
            for (let hash of Object.keys(covLayers).filter(x => x.indexOf(e.target.innerHTML) >= 0)) {
              for (let district in covLayers[hash]) {
                detail.map.addLayer(covLayers[hash][district]["polygon"])
                detail.map.addLayer(covLayers[hash][district]["icon"])
              }
            }
          });
        });
      }

      //----- add color code legend
      var legend = L.control({position: 'bottomright'});
      legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend'),
        grades = [0, 1, 5, 10, 20, 50, 100, 200],
        labels = [];
        // loop through our density intervals and generate a label with a colored square for each interval
        for (var i = 0; i < grades.length; i++) {
          div.innerHTML += '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' + grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
        }
        return div;
      };
      legend.addTo(detail.map);
    }, false);



    //=========================( Wait For Page Load )
    document.onreadystatechange = function () {
      if (document.readyState === 'complete') {
        //----- option button
        document.getElementsByClassName('biomod-options-icon')[0].addEventListener('click', function() {
          document.getElementsByClassName('biomod-options')[0].classList.toggle('tog');
          window.dispatchEvent(new Event('resize'));
        })
        window.dispatchEvent(new Event('resize'));
      }
    }
  </script>

{% endblock %}

{% block BioMod %}

  <div class="biomod biomod-container">
    <!--====================================================================================================( OPTIONS MENU )-->
    <div class="biomod biomod-options">
      <div class="dropdown" id="mapDropdown">
        <button class="btn btn-secondary btn-block dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Map Type
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
          <a class="dropdown-item">region</a>
          <a class="dropdown-item">county</a>
          <a class="dropdown-item">zip3</a>
        </div>
      </div>
    </div>

    <!--====================================================================================================( MAIN CONTENT )-->
    <div class="biomod biomod-content">
      <div class="biomod biomod-row">
        <div class="biomod biomod-options-icon"><img src="{% static '/newick/images/options.png' %}"></div>
        <div class="biomod biomod-module" style="flex-grow: 5;">
          {% leaflet_map "main" %}
        </div>

        <div class="biomod biomod-module" style="position: relative; overflow: scroll; flex-grow: 1;">
          <div id="covStats" style="margin: 5px;position: absolute;"></div>
        </div>
      </div>
    </div>
  </div>

{% endblock %}
