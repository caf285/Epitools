{% extends "demo/demo.html" %}

{% block static %}
  {{ block.super }}
  {% load leaflet_tags %}
  {% leaflet_css %}
  {% leaflet_js %}

  {% load static %}
  <script src="{% static '/newick/js/countyCoordinates.js' %}"></script>
  <script src="{% static '/newick/js/pcaCoordinates.js' %}"></script>
  <script src="{% static '/newick/js/colorPalette.js' %}"></script>
  <script src="{% static '/leaflet/leaflet-svgicon/demoAntibiogram-svg-icon.js' %}"></script>
  <script src="{% static '/plotly.js/dist/plotly.min.js' %}"></script>
  <style>
    .leaflet-container {  /* all maps */
      width: 60%;
      height: 800px;
      z-index: 1;
      margin-left: 40%;
    }
  </style>
{% endblock %}

{% block content %}

  {% leaflet_map "main" %}
  <div style="position:relative;">
    <div style="text-align:center;width:100%;position:absolute;top:-50px;z-index:100;">
      <div style="position: relative;top:-36px">
        <div id="yearScaleLabel" style="width:60%;margin-left:40%;font-size:36px;"></div>
        <div class="controls" style="width:60%;margin-left:40%;">
          <input style="width:300px;" type="range" id="yearScale" min="0" max="5">
        </div>
      </div>
    </div>
    <div style="width:40%;position:absolute;top:-800px;left:0;z-index:100;">
      <div id="testPlot" style="width:100%;height:800px;">
      </div>
    </div>
  </div>

  <script>
    // load database
    DB = {{ demoPCA|safe }}

    //----- MAP
    window.addEventListener("map:init", function (e) {
      var detail = e.detail;

      //----- base layers
      var baseLayers = {
        "Grey" : L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {'attribution': 'Esri &mdash; Esri, DeLorme, NAVTEQ', 'maxZoom': 16}),
        "Dark Grey" : L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}', {'attribution': 'Esri &mdash; Esri, DeLorme, NAVTEQ', 'maxZoom': 16}),
      };
      L.control.layers(baseLayers, null).addTo(detail.map);
      detail.map.addLayer(baseLayers["Grey"])

      //----- map layer groups
      var mapLevel = {"state":L.layerGroup(), "region":L.layerGroup(),"county":L.layerGroup(),"pca":L.layerGroup()}
      //L.control.layers(mapLevel).addTo(detail.map)

      var regionLayers = {};
      var countyLayers = {}; 
      var pcaLayers = {}; 

      // for each region
      for (var i = 0; i < Object.keys(DB.tree).length; i++) {
        let regionName = Object.keys(DB.tree)[i]
        regionLayers[regionName] = L.layerGroup()

        // for each county
        for (var j = 0; j < Object.keys(DB.tree[regionName]).length; j++) {
          let countyName = Object.keys(DB.tree[regionName])[j]
          var regionPolygon = L.polygon(countyPolygons[countyName], {
            title: countyName,
            clickable: true,
            color: fillColors("region")[i],
            opacity: 0.7,
            weight: 1,
            fillOpacity: 0.7
          });
          regionPolygon.on("click", function(e) {
            if (detail.map.hasLayer(mapLevel["state"])) {
              fillMap("region", regionName)
            } else {
              fillMap("county", e.target.options.title)
            }
          });
          regionLayers[regionName].addLayer(regionPolygon)

          countyLayers[countyName] = L.layerGroup()
          var countyPolygon = L.polygon(countyPolygons[countyName], {
            title: countyName,
            clickable: false,
            color: 'hsl(50, 100%, 0%)',
            opacity: 0,
            weight: 0,
            fillOpacity: 0.1
          });
          countyLayers[countyName].addLayer(countyPolygon)

          // for each pca
          for (var k = 0; k < Object.keys(DB.tree[regionName][countyName]).length; k++) {
            let pcaName = Object.keys(DB.tree[regionName][countyName]).reverse()[k]
            let pcaColors = fillColors("county")
            pcaLayers[pcaName] = L.layerGroup()
            if (pcaName == "Navajo Nation") {
              var polygonFill1 = L.polygon(pcaPolygons[pcaName]["Fill1"], {
                title: pcaName,
                clickable: true,
                color: pcaColors[k % pcaColors.length],
                opacity: 0.7,
                weight: 0,
                fillOpacity: 0.7,
                smoothFactor: 0.8
              });
              var polygonLine1 = L.polygon(pcaPolygons[pcaName]["Line1"], {
                title: pcaName,
                clickable: true,
                color: pcaColors[k % pcaColors.length],
                opacity: 0.7,
                weight: 1,
                fillOpacity: 0.0,
                smoothFactor: 0.8
              });
              var polygonLine2 = L.polygon(pcaPolygons[pcaName]["Line2"], {
                title: pcaName,
                clickable: true,
                color: pcaColors[k % pcaColors.length],
                opacity: 0.7,
                weight: 1,
                fillOpacity: 0.0,
                smoothFactor: 0.8
              });
              var polygonLine3 = L.polygon(pcaPolygons[pcaName]["Line3"], {
                title: pcaName,
                clickable: true,
                color: pcaColors[k % pcaColors.length],
                opacity: 0.7,
                weight: 1,
                fillOpacity: 0.0,
                smoothFactor: 0.8
              });
              group = new L.FeatureGroup();
              group.addLayer(polygonFill1);
              group.addLayer(polygonLine1);
              group.addLayer(polygonLine2);
              group.addLayer(polygonLine3);
              group.on("click", function(e) {
                if (detail.map.hasLayer(mapLevel["county"])) {
                  fillMap("pca", pcaName)
                } else {
                  fillMap("state", "")
                }
              });
              pcaLayers[pcaName].addLayer(group)
              countyLayers[countyName].addLayer(group)
            } else if (pcaName == "Hopi Tribe") {
              var polygonFill1 = L.polygon(pcaPolygons[pcaName]["Fill1"], {
                title: pcaName,
                clickable: true,
                color: pcaColors[k % pcaColors.length],
                opacity: 0.7,
                weight: 0,
                fillOpacity: 0.7,
                smoothFactor: 0.8
              });
              var polygonFill2 = L.polygon(pcaPolygons[pcaName]["Fill2"], {
                title: pcaName,
                clickable: true,
                color: pcaColors[k % pcaColors.length],
                opacity: 0.7,
                weight: 1,
                fillOpacity: 0.7,
                smoothFactor: 0.8
              });
              var polygonLine1 = L.polygon(pcaPolygons[pcaName]["Line1"], {
                title: pcaName,
                clickable: true,
                color: pcaColors[k % pcaColors.length],
                opacity: 0.7,
                weight: 1,
                fillOpacity: 0.0,
                smoothFactor: 0.8
              });
              var polygonLine2 = L.polygon(pcaPolygons[pcaName]["Line2"], {
                title: pcaName,
                clickable: true,
                color: pcaColors[k % pcaColors.length],
                opacity: 0.7,
                weight: 1,
                fillOpacity: 0.0,
                smoothFactor: 0.8
              });
              group = new L.FeatureGroup();
              group.addLayer(polygonFill1);
              group.addLayer(polygonFill2);
              group.addLayer(polygonLine1);
              group.addLayer(polygonLine2);
              group.on("click", function(e) {
                if (detail.map.hasLayer(mapLevel["county"])) {
                  fillMap("pca", pcaName)
                } else {
                  fillMap("state", "")
                }
              });
              countyLayers[countyName].addLayer(group)
              pcaLayers[pcaName].addLayer(group)
            } else {
              var pcaPolygon = L.polygon(pcaPolygons[pcaName], {
                title: pcaName,
                clickable: true,
                color: pcaColors[k % pcaColors.length],
                opacity: 0.7,
                weight: 1,
                fillOpacity: 0.7
              });
              pcaPolygon.on("click", function(e) {
                if (detail.map.hasLayer(mapLevel["county"])) {
                  fillMap("pca", pcaName)
                } else {
                  fillMap("state", "")
                }
              });
              countyLayers[countyName].addLayer(pcaPolygon)
              pcaLayers[pcaName].addLayer(pcaPolygon)
            }
          }
        }
      }
      fillMap("state", "")

      //----- map icon groups
      var regionIcons = {};
      var countyIcons = {}; 
      var pcaIcons = {}; 

      /* for each region
      for (var i = 0; i < Object.keys(DB.tree).length; i++) {
        let regionName = Object.keys(DB.tree)[i]
        regionIcons[regionName] = L.layerGroup()
        icon = L.Marker.SVGMarker(countyCoordinates[regionName], {
          iconOptions: {
            circleText: regionName,
            iconSize:  100
          }
        });

        // for each county
        for (var j = 0; j < Object.keys(DB.tree[regionName]).length; j++) {
          let countyName = Object.keys(DB.tree[regionName])[j]
          countyIcons[countyName] = L.layerGroup()

          // for each pca
          for (var k = 0; k < Object.keys(DB.tree[regionName][countyName]).length; k++) {
            let pcaName = Object.keys(DB.tree[regionName][countyName]).reverse()[k]
            pcaIcons[pcaName] = L.layerGroup() */


      //----- layer functions TODO
      function clearMap() {
        for (var i = 0; i < Object.keys(mapLevel).length; i++) {
          detail.map.removeLayer(mapLevel[Object.keys(mapLevel)[i]]);
        }
        for (var i = 0; i < Object.keys(DB.region).length; i++) {
          detail.map.removeLayer(regionLayers[DB.region[i]]);
        }
        for (var i = 0; i < Object.keys(DB.county).length; i++) {
          detail.map.removeLayer(countyLayers[DB.county[i]]);
        }
        for (var i = 0; i < Object.keys(DB.pca).length; i++) {
          detail.map.removeLayer(pcaLayers[DB.pca[i]]);
        }
      }

      function fillMap(level, label) {
        console.log(level)
        // add mode for complete state with region level detail
        if (level == "state") {
          clearMap();
          detail.map.addLayer(mapLevel["state"]);
          for (var i = 0; i < Object.keys(DB.region).length; i++) {
            detail.map.addLayer(regionLayers[DB.region[i]]);
          }
          // floating region labels (region names)
          // show state stats
        } else if (level == "region") {
          // show all COUNTIES in REGION
          clearMap()
          detail.map.addLayer(mapLevel[level])
          detail.map.addLayer(regionLayers[label])
          // color by AMR
          // floating county labels (AMR loadout WITH up/down arrow)
          // show stats by counties in group
        } else if (level == "county") {
          // show all PCAs in COUNTY
          clearMap()
          detail.map.addLayer(mapLevel[level])
          detail.map.addLayer(countyLayers[label])
          // color by AMR
          // floating PCA labels (AMR loadout WITH up/down arrow)
          // show stats by PCA in group
        } else if (level == "pca") {
          // show single PCA
          clearMap()
          detail.map.addLayer(mapLevel[level])
          detail.map.addLayer(pcaLayers[label])
          // color by AMR
          // floating PCA label
          // show PCA stats
        }
      }

      function fillColors(color) {
        let colorList = [];
        if (color == "region") {
          for (var i = 0; i < Object.keys(colorPalette).length; i++) {
            colorList.push(colorPalette[Object.keys(colorPalette).sort()[i]][2]);
          }
          return colorList;
        } else if (color == "county"){
          for (var i = 0; i < Object.keys(colorPalette).length; i++) {
            for (var j = 1; j < 4; j++) {
              colorList.push(colorPalette[Object.keys(colorPalette).sort()[i]][j]);
            }
          }
          return colorList;
        }
      }

/*    L.control.layers(baseLayers, overlays).addTo(detail.map);
      L.control.layers(pathogenType).addTo(detail.map);
      L.control.layers(colorType).addTo(detail.map);

      detail.map.addLayer(baseLayers["Grey"])
      detail.map.addLayer(pathogenType["MRSA, Oxicillin resistant"])
      detail.map.addLayer(colorType["%"])

      function fillSamples() {
        for (var i in years) {
          detail.map.removeLayer(sampleYears[years[i]]["overlay"]);
          sampleYears[years[i]]["overlay"].clearLayers()
        }

        for (var county in countyCoordinates) {
          for (var type in pathogenType) {
            if (detail.map.hasLayer(pathogenType[type]) && detail.map.hasLayer(overlays[county])) {

              if (detail.map.hasLayer(colorType["%"])) {
                let newColor = 100-parseInt(sampleYears[years[document.getElementById("yearScale").value]][county][type]["%"])
                overlays[county].setStyle({fillColor:"hsl(" + newColor + ",100%,50%)"})
              } else if (detail.map.hasLayer(colorType["n"])) {
                let newColor = parseInt(parseInt(sampleYears[years[document.getElementById("yearScale").value]][county][type]["n"])/10)
                if (newColor > 100) {
                  newColor = 100
                } else if (newColor < 0) {
                  newColor = 0
                }
                newColor = 100 - newColor
                overlays[county].setStyle({fillColor:"hsl(" + newColor + ",100%,50%)"})
              }

              document.getElementById("yearScaleLabel").innerHTML = type + " (" + years[document.getElementById("yearScale").value] + ")"
              sampleYears[years[document.getElementById("yearScale").value]]["overlay"].addLayer(newa L.Marker.SVGMarker(countyCoordinates[county], { iconOptions: { circleText: sampleYears[years[document.getElementById("yearScale").value]][county][type]["n"] + " (" + sampleYears[years[document.getElementById("yearScale").value]][county][type]["%"] + "%)", iconSize:  100}}));
            }
          }
        }
        detail.map.addLayer(sampleYears[years[document.getElementById("yearScale").value]]["overlay"])

        //console.log(overlays)
        //detail.map.removeLayer(overlays["Apache"])
        detail.map.addLayer(overlays["Flagstaff"])
      }

      function updateGraph() {
        var data = [];
        for (type in pathogenType) {
          pathogenGraph[type]['y'] = []
          data = []
          for (var county in countyCoordinates) {
            pathogenGraph[type]['y'].push(sampleYears[years[document.getElementById("yearScale").value]][county][type]["n"])
          }
        }
        Plotly.redraw(tester)

        detail.map.addLayer(overlays["Flagstaff"])
      }

      document.getElementById("yearScale").value = 0;
      document.getElementById("yearScaleLabel").innerHTML = years[document.getElementById("yearScale").value]

      fillSamples();
      detail.map.addLayer(sampleYears[years[document.getElementById("yearScale").value]]["overlay"])

      document.getElementById("yearScale").addEventListener('input', function(event) {
        fillSamples()
        updateGraph()
      });
      detail.map.on('baselayerchange', function () {
        fillSamples()
        updateGraph()
      })
      detail.map.on('overlayadd', function () {
        fillSamples()
        updateGraph()
      })
      detail.map.on('overlayremove', function () {
        fillSamples()
        updateGraph()
      })

      //var marker = new L.marker([37.003239, -110.754389]).addTo(detail.map);
      //var marker = new L.marker([36.409949, -110.750698]).addTo(detail.map);

      //var marker = new L.marker([36.078683, -111.082517]).addTo(detail.map);
      //var marker = new L.marker([36.074419, -110.750696]).addTo(detail.map);
      //var marker = new L.Marker.SVGMarker([35.1,-109.4], { iconOptions: { circleText:500 }}).addTo(detail.map);



      updateGraph()
      fillSamples()
*/    }, false);


    var tester = document.getElementById("testPlot");

    var colors = ["#A6D96A", "#D9EF8B", "#FEE08B", "#FDAE61", "#E2001A", "#A8121C", "#650D0D"]
    var countyCoordinates = {"Apache": [36.1,-109.479], "Cochise": [31.89,-109.72], "Coconino": [35.9,-111.654], "Gila": [33.7,-110.55], "Graham": [32.9,-109.9], "Greenlee": [33.35,-109.259], "LaPaz": [33.8,-113.9], "Maricopa": [33.55,-112.4], "Mohave": [35.4,-113.85], "Navajo": [34.939,-110.25], "Pima": [32.1,-111.8], "Pinal": [32.8,-111.3], "SantaCruz": [31.5,-110.81], "Yavapai": [34.524,-112.478], "Yuma": [32.7,-113.9]}
    var years = ["2013", "2014", "2015", "2016", "2017", "2018"]
    var pathogens = ["MRSA, Oxicillin resistant", "VRE, E. faecium Vancomycin resistant", "VRE, E. faecalis Vancomycin resistant", "ESBL, K. pneumoniae ESBL-positive", "ESBL, K. oxytoca ESBL-positive", "ESBL, E. coli ESBL-positive", "CRE, E. coli carbapenum resistant", "CRE, K. pneumoniae carbapenum resistant", "C. diff, #Pos/#tested"]

    var sampleYears = {};
    for (var i in years) {
      sampleYears[years[i]] = {};
      sampleYears[years[i]]["overlay"] = L.layerGroup([]);
      for (var county in countyCoordinates) {
        sampleYears[years[i]][county] = {};
        for (var j in pathogens) {
          sampleYears[years[i]][county][pathogens[j]] = {"n": 0, "%": 0}
        };
      };
    };


    var pathogenType = {"MRSA, Oxicillin resistant":L.layerGroup(), "VRE, E. faecium Vancomycin resistant":L.layerGroup(), "VRE, E. faecalis Vancomycin resistant":L.layerGroup(), "ESBL, K. pneumoniae ESBL-positive":L.layerGroup(), "ESBL, K. oxytoca ESBL-positive":L.layerGroup(), "ESBL, E. coli ESBL-positive":L.layerGroup(), "CRE, E. coli carbapenum resistant":L.layerGroup(), "CRE, K. pneumoniae carbapenum resistant":L.layerGroup(), "C. diff, #Pos/#tested":L.layerGroup()}
    var colorType = {"n":L.layerGroup(),"%":L.layerGroup()}

    var pathogenGraph = {}
    var thing = []
    for (var index in pathogenType) {
      pathogenGraph[index] = {'x': [], 'y': [], 'name': index, 'type': 'bar'}
      for (county in countyCoordinates) {
        pathogenGraph[index]['x'].push(county)
      }
      thing.push(pathogenGraph[index])
    }

    var layout = {barmode: 'stack', legend: {x: -0.2, y: 1.4}}
    Plotly.newPlot(tester, thing, layout)



  </script>

  <div id="query"></div>
<!--    {{ demoPCA }}


  <ul>
    <li>{{ demoPCA.region }}</li>
    <li>{{ demoPCA.county }}</li>
    <li>{{ demoPCA.pca }}</li>
  </ul>

  <ul>
  {% for i in demoPCA.tree.items %}
    <li>{{ i.0 }}</li>
    <ul>
    {% for j in i.1.items %}
      <li>{{ j.0 }}</li>
      <ul>
      {% for k in j.1.items %}
        <li>{{ k }}</li>
      {% endfor %}
      </ul>
    {% endfor %}
    </ul>
  {% endfor %}
  </ul>

-->









{% endblock %}














